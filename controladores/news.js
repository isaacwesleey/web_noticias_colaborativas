////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////// Funciones para las rutas de las noticias ////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////

'use strict';

const { generateError } = require('../helpers');

const {
  createNewsDB,
  getNewByIdDB,
  getNewsDB,
  editNewsDB,
} = require('../db/news');

/////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////// Ãšltimas noticias /////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////

const news = async (req, res, next) => {
  try {
    const news = await getNewsDB();

    res.send({
      status: 'ok',
      data: news,
    });
  } catch (error) {
    next(error);
  }
};

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////// Crear noticia ///////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////

const newNews = async (req, res, next) => {
  try {
    const { title, content, lede, theme } = req.body;

    if (!title || !content || !lede || !theme) {
      throw generateError('Faltan datos', 400);
    }

    const { id } = req.auth;

    await createNewsDB({ user_id: id, title, content, lede, theme });

    res.send({
      status: 'ok',
      message: 'Noticia creada',
    });
  } catch (error) {
    next(error);
  }
};
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////// Borrar noticia //////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////

const deleteNews = async (req, res, next) => {
  try {
    const { id } = req.params;

    const news = await getNewByIdDB(id);

    if (!news) {
      throw generateError(`La noticia con id ${id} no existe`, 404);
    }

    res.send({
      status: 'ok',
      message: 'Noticia borrada',
    });
  } catch (error) {
    next(error);
  }
};

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////// Editar noticia //////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////

const editNews = async (req, res, next) => {
  try {
    const { id } = req.params;
    const { title, content, lede, theme } = req.body;

    if (!title || !content || !lede || !theme) {
      throw generateError('Faltan datos', 400);
    }

    const news = await getNewByIdDB(id);

    if (!news) {
      throw generateError(`La noticia con id ${id} no existe`, 404);
    }

    await editNewsDB(id, title, content, lede, theme);

    res.send({
      status: 'ok',
      message: 'Noticia editada',
    });
  } catch (error) {
    next(error);
  }
};

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////// Noticia /////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////

const newById = async (req, res, next) => {
  try {
    const { id } = req.params;

    const news = await getNewByIdDB(id);

    if (!news) {
      throw generateError(`La noticia con id ${id} no existe`, 404);
    }

    res.send({
      status: 'ok',
      data: news,
    });
  } catch (error) {
    next(error);
  }
};

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////// Exportar controladores ///////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////

module.exports = {
  news,
  newNews,
  deleteNews,
  newById,
  editNews,
};
